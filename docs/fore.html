<h1 id="apay-四方接口">Apay 四方接口</h1>
<ol>
<li>下单</li>
</ol>
<hr>
<blockquote>
<p>http://<strong>url</strong>/forecore/order</p>
</blockquote>
<p>parameters:</p>
<p>| name | desc |
| -------- ｜ ----------------------------------------------- |
| cb_url   ｜ 充值结果回调地址，以http开头，如 <a href="http://mydomain.com/pay/result">http://mydomain.com/pay/result</a> |
| currency ｜ 充值币种，取决于您接入的通道不同，目前支持 CAD， USD, CNY |
| money    ｜ 充值数量，以元为单位，如 1.25 |
| outOrderId     ｜ 你方系统的订单号，必须是唯一的 |
| return_url     ｜ 充值界面的回跳地址，一般就显示充值成功 |
| time     ｜ 当前时间，毫秒单位 |
| userId     ｜ 你方系统中充值用户的id |
| type     ｜ 可以是 WECHATPAYH5，ALIPAYH5，UNIONPAYH5，不同通道支持不一样，请具体询问对接小伙伴 |</p>
<p>return</p>
<pre><code>    err, 错误，错误可能是字符串，对象，数字等，一般会有可以阅读部分。如果有err，以下参数全部不存在
    outOrderId, 你方系统的订单
    orderId， Apay的订单id
    url, 支付用地址</code></pre>
<ol start="2">
<li>查询</li>
</ol>
<hr>
<blockquote>
<p>http://<strong>url</strong>/forecore/queryOrder</p>
</blockquote>
<p>parameters</p>
<pre><code>    outOrderId , 你方订单id</code></pre>
<p>return</p>
<pre><code>    err, 错误，错误可能是字符串，对象，数字等，一般会有可以阅读部分。如果有err，以下参数全部不存在
    outOrderId, 你方订单id
    orderId， Apay订单id
    money， 订单要求支付的金额
    received， 用户支付的金额
    currency, 币种
    status， 订单状态</code></pre>
<ol start="3">
<li>退单</li>
</ol>
<hr>
<blockquote>
<p>http://<strong>url</strong>/forecore/refund</p>
</blockquote>
<p>请注意不是每个通道都支持退单</p>
<p>parameters</p>
<pre><code>    outOrderId, 你方订单id
    money， 退款数量，元为单位</code></pre>
<p>return</p>
<pre><code>err, 错误，错误可能是字符串，对象，数字等，一般会有可以阅读部分。如果有err，以下参数全部不存在
trans_no        | Transaction No.
out_order_no     | Original Order No. from the Merchant System.
out_refund_no    | The Refund transaction No. in the Merchant’s system.
trans_status    | Transaction status 
                    REFUNDING - transaction created, waiting for refund
                    CLOSE - transaction closed, refund failed.
                    SUCCESS - Refund success</code></pre>
<ol start="4">
<li>汇率</li>
</ol>
<hr>
<blockquote>
<p>http://<strong>url</strong>/forecore/exchangeRate</p>
</blockquote>
<p>parameters</p>
<pre><code>currency 币种 CAD USD
payment 支付方式 WECHATPAYH5 ALIPAYH5</code></pre>
<p>return </p>
<pre><code>err, 错误，错误可能是字符串，对象，数字等，一般会有可以阅读部分。如果有err，以下参数全部不存在
exchange_rate 汇率， 如7.012</code></pre>
<h1 id="附录">附录</h1>
<h2 id="cb_url的说明">cb_url的说明</h2>
<p>充值成功会以post方式回调这个接口，并且传递以下参数</p>
<p>outOrderId    | 你方系统产生的订单id
orderId        ｜ Apay的订单id
money        ｜ 支付的金额
currency    ｜ 币种
sign        ｜ 以md5做的签名</p>
<p>收到这个调用之后，请返回一个json对象，如果有错，返回<code>{err:&#39;something wrong&#39;}</code>
如果正常处理完成，返回任意的json对象，如 <code>{result:&#39;success&#39;}</code></p>
<h2 id="调用接口">调用接口</h2>
<p>所有接口都同时支持post或者get方式，如果选择post方式，以form-urlencode方式上传参数。任何接口的返回值都是一个json对象，如果这个json中包含有err字段，那意味着调用出错。</p>
<p>调用上述4个接口中的任何一个，都需要附上公共参数，如下</p>
<p>partnerId    ｜ 合作商id， Apay分配的
sign        ｜ 签名，算法见下一节</p>
<h2 id="签名算法">签名算法</h2>
<p>签名是md5</p>
<p>我们以一个例子来说明签名的构成。假定我们要传递的参数如下：
<code>outOrderId=&#39;abc123&#39;, money=1.00, partnerId=&#39;p001&#39;, type=&#39;WECHATPAYH5&#39;, currency=&#39;USD&#39;</code></p>
<p>签名的key是<code>123456</code></p>
<ol>
<li>将所有待传递的参数按照参数名升序排列,得到
<code>currency=&#39;USD&#39;, money=1.00, outOrderId=&#39;abc123&#39;, partnerId=&#39;p001&#39;, type=&#39;WECHATPAYH5&#39; </code></li>
<li>所有的值做urlEncode，得到
 <code>currency=&#39;USD&#39;, money=1.00, outOrderId=&#39;abc123&#39;, partnerId=&#39;p001&#39;, type=&#39;WECHATPAYH5&#39; </code></li>
<li>输出<code>key=value</code>并用&amp;连接成字符串，得到
 <code>currency=USD&amp;money=1.00&amp;outOrderId=abc123&amp;partnerId=p001&amp;type=WECHATPAYH5</code></li>
<li>在字符串前面加上key， 得到
 <code>123456currency=USD&amp;money=1.00&amp;outOrderId=abc123&amp;partnerId=p001&amp;type=WECHATPAYH5</code></li>
<li>对这个字符串计算md5, 得到
<code>a90a66d09bde8a32725c9efde082fae1</code></li>
<li>把这个结果填给sign，那么最后要传输的数据<pre><code>outOrderId=&#39;abc123&#39;, 
money=1.00, 
partnerId=&#39;p001&#39;, 
type=&#39;WECHATPAYH5&#39;, 
currency=&#39;USD&#39;,
sign=&#39;a90a66d09bde8a32725c9efde082fae1&#39;</code></pre>
</li>
</ol>
<h2 id="关于结算货币">关于结算货币</h2>
<p>如果提单时使用外币，结算也会结算外币。因此下单时需要按照实时汇率换算，比如美元汇率是7.01，如果要生成100人民币的订单，你应该下100/7.01=14.27美元的支付订单。
如果下单人民币则无需考虑汇率</p>
<h2 id="使用微信支付">使用微信支付</h2>
<p>下单外币时系统返回的url只能在微信浏览器中打开付款，如果在chrome之类的系统浏览器中会显示</p>
<blockquote>
<p>请使用微信浏览器打开</p>
</blockquote>
<p>这显然不是你想看到的。那么处理方式是</p>
<ol>
<li>将这个url显示成二维码，让用户用微信扫码，<ul>
<li>如果在pc端，直接显示这个二维码</li>
<li>如果在手机端，提示用户截屏，在微信里扫一扫，选择相册</li>
</ul>
</li>
</ol>
<p>下单人民币时不存在这个问题</p>
