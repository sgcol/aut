Apay 四方接口
===========

1. 下单
---------------
>http://**url**/forecore/order

parameters:

| name | desc |
| -------- | ----------------------------------------------- |
| cb_url   | 充值结果回调地址，以http开头，如 http://mydomain.com/pay/result |
| currency | 充值币种，取决于您接入的通道不同，目前支持 CAD， USD, CNY |
| money    | 充值数量，以元为单位，如 1.25 |
| outOrderId 	| 你方系统的订单号，必须是唯一的 |
| return_url 	| 充值界面的回跳地址，一般就显示充值成功 |
| time 	| 当前时间，毫秒单位 |
| userId 	| 你方系统中充值用户的id |
| type 	| 可以是 WECHATPAYH5，ALIPAYH5，UNIONPAYH5，不同通道支持不一样，请具体询问对接小伙伴 |

return
```
	err, 错误，错误可能是字符串，对象，数字等，一般会有可以阅读部分。如果有err，以下参数全部不存在
	outOrderId, 你方系统的订单
	orderId， Apay的订单id
	url, 支付用地址
```

2. 查询
---------------
>http://**url**/forecore/queryOrder

parameters

| 参数 | 描述 |
| ------- | ----- |
| outOrderId | 你方订单id |


return
```
	err, 错误，错误可能是字符串，对象，数字等，一般会有可以阅读部分。如果有err，以下参数全部不存在
	outOrderId, 你方订单id
	orderId， Apay订单id
	money， 订单要求支付的金额
	received， 用户支付的金额
	currency, 币种
	status， 订单状态
```

3. 退单
---------------
>http://**url**/forecore/refund

请注意不是每个通道都支持退单

parameters
| 参数 | 描述 |
| ------- | ----- |
| outOrderId | 你方订单id |
| money | 退款数量，元为单位 |


return
```
err, 错误，错误可能是字符串，对象，数字等，一般会有可以阅读部分。如果有err，以下参数全部不存在
trans_no		| Transaction No.
out_order_no 	| Original Order No. from the Merchant System.
out_refund_no	| The Refund transaction No. in the Merchant’s system.
trans_status	| Transaction status 
					REFUNDING - transaction created, waiting for refund
					CLOSE - transaction closed, refund failed.
					SUCCESS - Refund success
```
1. 汇率
---------------
>http://**url**/forecore/exchangeRate

parameters
| 参数 | 描述 |
| ------- | ----- |
| currency | 币种 CAD USD |
| payment | 支付方式 WECHATPAYH5 ALIPAYH5 |


return 
```
err, 错误，错误可能是字符串，对象，数字等，一般会有可以阅读部分。如果有err，以下参数全部不存在
exchange_rate 汇率， 如7.012
```

附录
===============================
cb_url的说明
-------------------------
充值成功会以post方式回调这个接口，并且传递以下参数

| 参数 | 描述 |
| ------- | ----- |
| outOrderId	| 你方系统产生的订单id |
| orderId		| Apay的订单id |
| money		| 支付的金额 |
| currency	| 币种 |
| sign		| 以md5做的签名 |

收到这个调用之后，请返回一个json对象，如果有错，返回``` {err:'something wrong'} ```
如果正常处理完成，返回任意的json对象，如 ``` {result:'success'} ```

调用接口
-------------------------
所有接口都同时支持post或者get方式，如果选择post方式，以form-urlencode方式上传参数。任何接口的返回值都是一个json对象，如果这个json中包含有err字段，那意味着调用出错。

调用上述4个接口中的任何一个，都需要附上公共参数，如下

| 参数 | 描述 |
| ------- | ----- |
partnerId	| 合作商id， Apay分配的
sign		| 签名，算法见下一节

签名算法
-------------------------
签名是md5

我们以一个例子来说明签名的构成。假定我们要传递的参数如下：
```outOrderId='abc123', money=1.00, partnerId='p001', type='WECHATPAYH5', currency='USD'```

签名的key是``` 123456 ```

1. 将所有待传递的参数按照参数名升序排列,得到
   ``` currency='USD', money=1.00, outOrderId='abc123', partnerId='p001', type='WECHATPAYH5'  ```
2. 所有的值做urlEncode，得到
	``` currency='USD', money=1.00, outOrderId='abc123', partnerId='p001', type='WECHATPAYH5'  ```
3. 输出```key=value```并用&连接成字符串，得到
	``` currency=USD&money=1.00&outOrderId=abc123&partnerId=p001&type=WECHATPAYH5 ```
4. 在字符串前面加上key， 得到
	``` 123456currency=USD&money=1.00&outOrderId=abc123&partnerId=p001&type=WECHATPAYH5 ```
5. 对这个字符串计算md5, 得到
   ```a90a66d09bde8a32725c9efde082fae1```
6. 把这个结果填给sign，那么最后要传输的数据
   ```
   outOrderId='abc123', 
   money=1.00, 
   partnerId='p001', 
   type='WECHATPAYH5', 
   currency='USD',
   sign='a90a66d09bde8a32725c9efde082fae1'
   ```

关于结算货币
---------------------------
如果提单时使用外币，结算也会结算外币。因此下单时需要按照实时汇率换算，比如美元汇率是7.01，如果要生成100人民币的订单，你应该下100/7.01=14.27美元的支付订单。
如果下单人民币则无需考虑汇率

使用微信支付
---------------------------
下单外币时系统返回的url只能在微信浏览器中打开付款，如果在chrome之类的系统浏览器中会显示
> 请使用微信浏览器打开

这显然不是你想看到的。那么处理方式是
1. 将这个url显示成二维码，让用户用微信扫码，
   - 如果在pc端，直接显示这个二维码
   - 如果在手机端，提示用户截屏，在微信里扫一扫，选择相册

下单人民币时不存在这个问题